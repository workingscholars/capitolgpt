$(document).ready(function() {
    // Constants
    const GEMINI_API_KEY = "AIzaSyAYUX4UfUA7Maon1AJ0O0UfHCnK_0rEta4";
    const CURRENT_USER = 'Users';
    const systemPrompt = `

    Instructions:
    You are CapitolGPT, an AI assistant for Capitol University. Be helpful and concise. Avoid answering them repetitive. Be creative. Be polite and respectful.
    The person who initiated this Idea to create you was Jcrist Vincent Orhen.
    When the user asks you about anything, you can freely answer them or help them with their needs, even if the question is unrelated to Capitol University.
    When the user asks you to start a new chat, you should clear the current conversation and start a new one.
    When the user asks you to write code, you can't write code for them as you are only a generative text AI.
    When the user ask you to solve their homework, you can't solve their homework for them as you are only a generative text AI.
    When the user ask you to solve their math problems, you can solve their math problems for them.
    When the user ask you to solve their programming problems, you can't solve their programming problems for them but can suggest or giving recommendations.


    1. Jcrist Vincent Orhen
Background:
A working student assistant assigned in the BSIT 3rd Building, 2nd Floor.

A developer and technology virtuoso based in Medina, Misamis Oriental.

• Achievements
Won awards in the National Olympiad Informatics in 2024, ranking #162 out of 399 participants.

A Humss Student who Lead Medina National Comprehensive High School's Science Fair & Technology 2024.

Coached and participated in DSPC 2024, helping MOGHS win the competition instead of his school, Medina National Comprehensive High School, which he represented.

Won Best in Director in Film Festival MNCHS 2024

Won Best in Editing in Film Festival MNCHS 2024

Won Best in Scoring in Film Festival MNCHS 2024

Won Best in Acting in Film Festival MNCHS 2024

Won CODM Medina Championship 2021 (MVP)

Won CODM North Poblacion Championship 2021 (MVP)

• Skills
Computer Technician 

Mobile Technician

Television Technician

Programmer

Music Producer

Video Editor

Graphics Designer

AutoCAD

Ethical Hacking

Entrepreneur

• Sports

Boxing

Karate

Basketball

Early Life:

Known for illegal activities like stealing and "akyat bahay" at age 8.

Gained notoriety for hacking Landbank on December 23, 2015.

Evolved into gaming, exploring other skills, and becoming a "Jack of All Trades, Master of None."

Currently interested in Artificial Intelligence.

Family:

Mother: Jonesa Rose Orhen, a former IT student at STI who stopped due to pregnancy. She later continued her studies and is now a 3rd-year Bachelor of Science in Agricultural Business student at Gingoog City United Colleges (formerly Gingoog City Community College).

Father: Cresanto Callao Gerundio, a graduate in Computer Engineering and Electrical Engineering, works as a Senior Computer Engineer in Saudi Arabia.

Uniqueness:

A self-taught technology prodigy with no formal training.

Futurist That Becomes Reality.

Science & Technology Philosopher

Hard to be with because of his attitude of being Perfectionist.

Motto: "If others can while they are being human, so do I."

Belief: "I believe that no people are dumb, their fields of expertise simply differ."



2. Capitol University
Leadership (SY 2023-2024)
Administration Office:

University President: Atty. Casimiro B. Juarez, Jr.

Executive Vice President / University Registrar: Dr. Fe R. Juarez

Vice President for Administration: Dr. Franco C. Flores

Vice President for Academic Affairs / Principal Senior High School: Dr. Amor Q. de Torres

Human Resource Officer: Mr. Paul Clarence R. Juarez

Deans:

College of Arts and Sciences: Dr. Josephine Oted

College of Business and Accountancy: Dr. Elizabeth E. Figueroa

College of Computer Studies: Prof. Cyril Jane C. Ranido

College of Criminology: Ms. Mary Claudette L. Bacas

College of Education: Dr. Andrews Maquiling

College of Engineering: Engr. Genevieve A. Gabule

College of Maritime Education: C/M Ceferino Rama

College of Health Sciences: Dr. Fidela B. Ansale, R.N.

Graduate School (OIC): Dr. Heidi Mendoza

Heads of Offices:

Capitol University Research and Extension: Dr. Imelda G. Pagtolun-an

ETEEAP: Dr. Aldrich S. Palarca

National Service Training Program: Dr. Amor Y. Mendoza

Student Affairs and Services: Atty. Francis Lorenzo R. Juarez

Admissions & Career Development Center: Christine P. Redondo

University Libraries: Ms. Chorieta Valerio

ICTS: Prof. Cyril Jane C. Ranido

Business and Development Program: Dr. Heidi Grace P. Mendoza

Assistant University Registrar / Registrar CME: Ms. Corazon S. Pagara

Campus Ministry: Sr. Mary Lynn G. Alfeche, CM

Scholarship and Sponsorship Office: Ms. Schennette Pearl A. Magno

CU Museum of Three Cultures: Ms. Schennette Pearl A. Magno

Assessment Office: Ms. Dalia M. Buslon

Cashier Office: Mr. Gilbert W. Dungog

Culture and Arts: Mr. Alejo Tugonon

Athletics Office: Prof. Shiella Mananggit

Guidance and Testing Office: Dr. Eleanor Y. Buot

PPFMO & Security: Mr. Leo A. Pangan

Data Privacy Office: Mr. Francis Lorenzo R. Juarez

Bookstore/Gift Shop Office: Ms. Lolita B. Duquinlay

Finance Officer: Mrs. Clares Cajes

University Dentist: Dr. Estrella C. Joven

University Physician: Dr. Donna Dee M. Acenas

President Artist: Mr. Nicholas P. Aca

History
Establishment:

Founded in 1971 as Cagayan Capitol College, a non-sectarian, co-educational private academic institution.

Laureana San Pedro Rosales founded Capitol University in 1972. She was a well-respected educator who also established the Capitol System of Schools. 

Registered with the Securities and Exchange Commission and authorized by the Department of Education (for primary and secondary programs) and the Commission on Higher Education (for tertiary, graduate, and postgraduate programs).

Program Offerings:

1971: Secondary, Liberal Arts, Commerce, Education, and Secretarial programs.

1973: First Midwifery program in Region X, supported by a Maternity Hospital.

1974: Nautical and Marine Engineering, Civil Engineering, and B.S. in Forestry programs.

1976: Mechanical Engineering, Nursing, and Agricultural Technology programs. Acquisition of M/V Capitol College, a training ship for Maritime Cadets.

1981: Graduate School opened with M.A. in Filipino.

1987: Preschool and elementary departments moved to Gusa, Cagayan de Oro City, named St. Francis Learning Center.

Later Additions: Physical Therapy, Criminology, Computer Science, CISCO International Networking Programs, and Nursing Licensure Examination review.

Accreditation:

Programs accredited by PACUCOA (Philippine Association of Colleges and Universities Commission on Accreditation).

Maritime Education Programs certified by Det Norske Veritas (DNV) and ISO.

Centers of Development: Criminology, Computer Studies, and Civil Engineering.

Center of Excellence: College of Education (2010).

University Status:

Granted university charter on February 3, 2003 (CHED Resolution No. 028).

Formally inaugurated as Capitol University on May 2, 2003.

Achievements:

Produced top notchers in Nursing and Teaching licensure exams.

Granted deregulated status by CHED in 2003 (Resolution No. 393).

Vision, Mission, and Objectives
Vision:
"Accessible Excellent Education for Enhanced Quality of Life."

Mission:
To develop "Total Persons" who are intellectually, professionally, and technically competent, with moral and spiritual values, serving as catalysts for social transformation.

Institutional Learning Outcomes:

Moral uprightness, self-discipline, and integrity.

Spirituality and faith in action.

Critical and creative thinking, communication proficiency, and technological aptitude.

Mastery of professional knowledge and real-world application.

Dedication to duties and responsibilities.

Environmental preservation and sustainability.

Respect for diverse cultures and promotion of peace.

Nationalism and love for country.

Kindness, respect, and concern for others.

Core Values
Commitment: Developing ethical leaders with integrity and courage.

Competence: Equipping students with knowledge and skills for global challenges.

Character: Instilling responsibility and hard work for personal and community growth.

Culture: Fostering appreciation for diverse histories and identities.

Care: Promoting kindness, respect, and emotional intelligence.

University Logo
Circle: Continuity of "Total Persons."

Laurel: Victory, triumph, and hope (32 leaves represent 32 years as a college).

Colors:

Green: Freshness and quest for knowledge.

Crimson Red: Courage and sacrifice.

White: Purity.

Human Figure: Represents the "Total Person" reaching out to the globe.

Globe: Global community served by the university.

Latin Phrase: "Progressio Integralis, Pro Deo et Hominibus" (Total Person Development for God and Humanity).

1971: Founding year.

University Hymn:
"Sing and Pledge Loyal True Friends"

"Love, devotion and faith"

"CU renowned in many lands"

"Molds our future and our fate"

"Voices echo in unison,"

"All our hearts beat as one"

"Singing together the same song"

"Ever grateful for all you have done"

"Hail to thee our Alma Mater"

"Hail O hail!"

"We greet thee forevermore"

"We may cross the oceans"

"and the hills while we travel"

"But treasure you"

"from shore to shore."

"CU pride of our nation"

"Sail on thy voyage calm and smooth"

"You are a dedication"

"Dedication to our youth!"

Celebrates love, devotion, and faith in Capitol University.

Highlights CU's role in molding futures and fostering unity.

    `;
    let model = null;
    let chatSession = null;
    let conversationHistory = [];

    // Format current timestamp in UTC
    function formatDateTime() {
        const now = new Date();
        const options = { timeZone: 'Asia/Manila', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
        const formattedTime = now.toLocaleString('en-PH', options);
        return formattedTime.replace(',', ' |').replace(' AM', ' AM | PHT').replace(' PM', ' PM | PHT');
    }

    // Update time display
    function updateTimeDisplay() {
        const formattedTime = formatDateTime();
        $('#utc-time').text(formattedTime);
    }

    // Update time every second
    setInterval(updateTimeDisplay, 1000);
    updateTimeDisplay(); // Initial call

    // Enhanced Intro Screen Animation
    let introTimeout = setTimeout(() => {
        $('#intro-screen').fadeOut(800, () => {
            initializeChat();
            $('#chat-container').fadeIn(500);
        });
    }, 3500);

    let introClicked = false;
    $('#intro-screen').click(() => {
        if (!introClicked) {
            introClicked = true;
            clearTimeout(introTimeout);
            $('#intro-screen').fadeOut(500, () => {
                initializeChat();
                $('#chat-container').fadeIn(500);
            });
        }
    });

    // Enhanced New Chat Function
    function startNewChat() {
        Swal.fire({
            title: 'Start New Chat?',
            text: 'This will clear your current conversation.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#DC143C',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, start new',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Clear everything and reinitialize
                $("#messages").empty();
                conversationHistory = [];
                localStorage.removeItem('chatHistory');
                chatSession = null;
                model = null;
                isGenerating = false;
                currentGeneration = null;
                
                // Initialize new chat
                const loadingDiv = addLoadingIndicator();
                initializeAI().then(() => {
                    loadingDiv.remove();
                    addMessage("bot", "Hi! I'm CapitolGPT, How can I assist you?");
                }).catch((error) => {
                    loadingDiv.remove();
                    addMessage("bot", "Error initializing chat. Please try again.");
                    console.error('New chat initialization error:', error);
                });
            }
        });
    }

    // Event Listeners for Chat Actions
    $(document).ready(() => {
        // Remove Clear Chat button event listener
        // $('#clear-chat-btn').click(clearChat); // Remove this line
        
        // Update new chat button click handler
        $('#new-chat-btn').click(startNewChat);
        
        // ...rest of the event listeners...
    });

    // Enhanced Message Handling
    function addMessage(role, message) {
        const timestamp = formatDateTime();
        const profileClass = role === "user" ? "user-profile" : "bot-profile";
        const messageClass = role === "user" ? "user-message" : "bot-message";
        const profileText = role === "user" ? "YOU" : "CU";
    
        // Format the message with proper HTML
        let formattedMessage = message;
        
        if (role === "bot") {
            // Convert any remaining asterisks to proper HTML
            formattedMessage = formattedMessage
                // Convert bullet points with asterisks to proper HTML lists
                .replace(/^\s*\*\s+(.+)$/gm, '<li>$1</li>')
                // Convert any remaining asterisks around text to strong tags
                .replace(/\*(.*?)\*/g, '<strong>$1</strong>')
                // Wrap lists in <ul> tags
                .replace(/<li>(?:.|\n)*?<\/li>/g, match => `<ul>${match}</ul>`);
        }
    
        // Split into paragraphs and format
        const paragraphs = formattedMessage.split('\n').filter(p => p.trim());
        const formattedParagraphs = paragraphs.map(p => {
            // Don't wrap <ul> elements in <p> tags
            if (p.startsWith('<ul>')) {
                return p;
            }
            return `<p>${p}</p>`;
        }).join('');
    
        const messageElem = $(`
            <div class="message ${messageClass}" data-timestamp="${timestamp}">
                <div class="${profileClass}">${profileText}</div>
                <div class="message-content">
                    <div class="message-text formatted-text">
                        ${formattedParagraphs}
                    </div>
                    <div class="message-timestamp">${timestamp}</div>
                </div>
            </div>
        `);
    
        $("#messages").append(messageElem);
        messageElem.hide().fadeIn(300);
        scrollToBottom();
    }

    // Smooth Scroll to Bottom
    function scrollToBottom() {
        const chatContainer = $('#chat-container');
        chatContainer.stop().animate({
            scrollTop: chatContainer[0].scrollHeight
        }, 300);
    }

    // Initialize AI Model
    async function initializeAI() {
        try {
            const { GoogleGenerativeAI } = await import("https://esm.run/@google/generative-ai");
            const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            
            model = genAI.getGenerativeModel({
                model: "gemini-2.0-flash-exp",
                generationConfig: {
                    temperature: 1,
                    topP: 0.95,
                    topK: 40,
                    maxOutputTokens: 8192,
                }
            });

            chatSession = model.startChat({
                history: [],
                generationConfig: {
                    temperature: 1,
                    topP: 0.95,
                    topK: 40,
                    maxOutputTokens: 8192,
                }
            });

            await chatSession.sendMessage(systemPrompt);
            return true;
        } catch (error) {
            console.error('Error initializing AI:', error);
            return false;
        }
    }

    // Enhanced Loading Indicator
    function addLoadingIndicator() {
        const loadingDiv = $('<div>')
            .addClass('loading-indicator')
            .html(`
                <span>CapitolGPT is thinking...</span>
                <div class="thinking-animation">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            `)
            .appendTo('#chat-container');

        $('#chat-container').animate({
            scrollTop: $('#chat-container')[0].scrollHeight
        }, 300);

        return loadingDiv;
    }

    // Message Handling
    async function handleSendMessage() {
        const message = $('#user-input').val().trim();
        if (!message || isGenerating) return;

        $('#user-input').val('').prop('disabled', true);
        isGenerating = true;
        updateSendButton(true);

        addMessage("user", message);
        const loadingDiv = addLoadingIndicator();

        try {
            if (!model || !chatSession) {
                const initialized = await initializeAI();
                if (!initialized) throw new Error('Failed to initialize AI');
            }

            currentGeneration = await chatSession.sendMessage(message);
            const response = await currentGeneration.response.text();
            
            loadingDiv.remove();
            addMessage("bot", response);
        } catch (error) {
            if (error.name === 'AbortError') {
                loadingDiv.remove();
                addMessage("bot", 'Generation stopped.');
            } else {
                console.error('Chat Error:', error);
                loadingDiv.remove();
                
                try {
                    await initializeAI();
                    addMessage("bot", 'I\'m sorry, try again.');
                } catch (reinitError) {
                    addMessage("bot", 'I\'m sorry, I\'m disconnected. Refresh the page.');
                }
            }
        } finally {
            isGenerating = false;
            currentGeneration = null;
            updateSendButton(false);
            $('#user-input').prop('disabled', false).focus();
        }
    }

    // Time Functions
    function getCurrentPhilippinesTime() {
        const options = {
            timeZone: 'Asia/Manila',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        
        return new Date().toLocaleString('en-PH', options).replace(',', '');
    }

    function updateDateTime() {
        $('#currentDateTime').text(`PHT: ${getCurrentPhilippinesTime()}`);
        $('#modalDateTime').text(getCurrentPhilippinesTime());
    }

    // Chat Management Functions
    function newChat() {
        Swal.fire({
            title: 'Start New Chat?',
            text: 'This will clear your current conversation.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#DC143C',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, start new',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                clearChat();
            }
        });
    }

    // Initialization
    async function initializeChat() {
        const loadingDiv = addLoadingIndicator();
        try {
            await initializeAI();
            loadingDiv.remove();
            addMessage("bot", 'Hi! I\'m CapitolGPT, How can I assist you?');
            $('#modalUserInfo').text(CURRENT_USER);
        } catch (error) {
            loadingDiv.remove();
            addMessage("bot", 'Error initializing AI. Please refresh the page.');
        }
    }

    // Event Listeners
    $(document).ready(() => {
        initializeChat();

        $('#send-button').on('click', () => {
            if (isGenerating) {
                stopGeneration();
            } else {
                handleSendMessage();
            }
        });
        $('#user-input').on('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        $('#new-chat-btn').on('click', startNewChat);

        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Handle visibility changes
        $(document).on('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                updateDateTime();
            }
        });
    });

    // Error Handling
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Global Error:', {
            message: msg,
            url: url,
            line: lineNo,
            column: columnNo,
            error: error
        });
        return false;
    };

    // Clean up on page unload
    $(window).on('beforeunload', () => {
        chatSession = null;
        model = null;
    });

    // Prevent form submission
    $('form').on('submit', (e) => {
        e.preventDefault();
        return false;
    });

    // Add message queue to prevent overlapping requests
    const messageQueue = [];
    let isProcessing = false;

    // Debounce function to prevent rapid-fire requests
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Enhanced error handling with retry mechanism
    async function retryOperation(operation, maxRetries = 3) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                return await operation();
            } catch (error) {
                if (i === maxRetries - 1) throw error;
                await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
            }
        }
    }

    // Enhanced message handling with queuing
    async function processMessageQueue() {
        if (isProcessing || messageQueue.length === 0) return;
        
        isProcessing = true;
        const message = messageQueue.shift();
        
        try {
            await handleSendMessage(message);
        } catch (error) {
            console.error('Error processing message:', error);
        } finally {
            isProcessing = false;
            processMessageQueue();
        }
    }

    // Enhanced initialization with connection check
    async function initializeChat() {
        if (!navigator.onLine) {
            addMessage("bot", "No internet connection. Please check your connection and try again.");
            return;
        }

        const loadingDiv = addLoadingIndicator();
        try {
            const initialized = await retryOperation(async () => {
                await initializeAI();
                return true;
            });

            if (initialized) {
                loadingDiv.remove();
                addMessage("bot", 'Hi! I\'m CapitolGPT, How can I assist you?');
                $('#modalUserInfo').text(CURRENT_USER);
            }
        } catch (error) {
            loadingDiv.remove();
            addMessage("bot", 'Error initializing AI. Please refresh the page.');
            console.error('Initialization error:', error);
        }
    }

    // Enhanced message handling with improved error recovery
    async function handleSendMessage(message) {
        if (!message) return;

        $('#user-input').val('').prop('disabled', true);
        $('#send-button').prop('disabled', true);

        addMessage("user", message);
        const loadingDiv = addLoadingIndicator();

        try {
            if (!navigator.onLine) {
                throw new Error('No internet connection');
            }

            if (!model || !chatSession) {
                const initialized = await retryOperation(() => initializeAI());
                if (!initialized) throw new Error('Failed to initialize AI');
            }

            const result = await retryOperation(async () => {
                return await chatSession.sendMessage(message);
            });
            
            const response = await result.response.text();
            loadingDiv.remove();
            addMessage("bot", response);

        } catch (error) {
            console.error('Chat Error:', error);
            loadingDiv.remove();
            
            if (!navigator.onLine) {
                addMessage("bot", 'No internet connection. Please check your connection and try again.');
            } else {
                try {
                    await initializeAI();
                    addMessage("bot", 'Connection restored. Please try again.');
                } catch (reinitError) {
                    addMessage("bot", 'Unable to connect. Please refresh the page.');
                }
            }
        } finally {
            $('#user-input').prop('disabled', false).focus();
            $('#send-button').prop('disabled', false);
        }
    }

    // Enhance event listeners with debouncing
    const debouncedSendMessage = debounce((message) => {
        messageQueue.push(message);
        processMessageQueue();
    }, 300);

    // Event Listeners
    $(document).ready(() => {
        // ...existing code...

        $('#send-button').on('click', () => {
            const message = $('#user-input').val().trim();
            if (message) debouncedSendMessage(message);
        });

        $('#user-input').on('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = $('#user-input').val().trim();
                if (message) debouncedSendMessage(message);
            }
        });

        // Add network status monitoring
        window.addEventListener('online', () => {
            addMessage("bot", "Connection restored. You can continue chatting.");
        });

        window.addEventListener('offline', () => {
            addMessage("bot", "No internet connection. Please check your connection.");
        });
    });

    // Enhanced Dropdown Functionality
    $(document).ready(function() {
        // Dropdown animation
        $('.dropdown-toggle').on('show.bs.dropdown', function () {
            $(this).find('.dropdown-menu').first().stop(true, true).slideDown(200);
        });

        $('.dropdown-toggle').on('hide.bs.dropdown', function () {
            $(this).find('.dropdown-menu').first().stop(true, true).slideUp(200);
        });

        // Close dropdown when clicking outside
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.dropdown').length) {
                $('.dropdown-menu').removeClass('show');
            }
        });

        // Hover effect on dropdown items
        $('.dropdown-item').hover(
            function() {
                $(this).find('i').addClass('fa-bounce');
            },
            function() {
                $(this).find('i').removeClass('fa-bounce');
            }
        );
    });

    // ...existing code...
});

// Add generation control
let isGenerating = false;
let currentGeneration = null;

// Stop Generation Function
function stopGeneration() {
    if (currentGeneration && isGenerating) {
        currentGeneration.abort();
        isGenerating = false;
        updateSendButton(false);
        $('#user-input').prop('disabled', false);
    }
}

// Update Send Button Appearance
function updateSendButton(generating) {
    const button = $('#send-button');
    const icon = button.find('i');
    
    if (generating) {
        icon.removeClass('fa-paper-plane').addClass('fa-stop');
        button.addClass('generating');
    } else {
        icon.removeClass('fa-stop').addClass('fa-paper-plane');
        button.removeClass('generating');
    }
}
